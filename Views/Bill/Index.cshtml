@model List<EchoPOS.Models.BillViewModel>
@{
    ViewBag.Title = "All Bills";
}

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />

<div class="container mt-4">

    <!-- Filter Dropdown -->
    <div class="row mb-3">
        <div class="col-md-3">
            <select id="filterType" class="form-control">
                <option value="day">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
            </select>
        </div>
    </div>

    <!-- Payment Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white text-center">
                <div class="card-body">
                    <h5 class="card-title">Cash Collection</h5>
                    <p class="card-text">₹ @ViewBag.CashTotal</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white text-center">
                <div class="card-body">
                    <h5 class="card-title">UPI Collection</h5>
                    <p class="card-text">₹ @ViewBag.UPITotal</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white text-center">
                <div class="card-body">
                    <h5 class="card-title">Card Collection</h5>
                    <p class="card-text">₹ @ViewBag.CardTotal</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white text-center">
                <div class="card-body">
                    <h5 class="card-title">Total Collection</h5>
                    <p class="card-text">₹ @ViewBag.GrandTotal</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bill Table -->
    <h2 class="mb-3">All Bills</h2>

    <table class="table table-bordered" id="billsTable">
        <thead class="thead-dark">
            <tr>
                <th>Bill ID</th>
                <th>Order ID</th>
                <th>Tax (%)</th>
                <th>Discount (₹)</th>
                <th>Total (₹)</th>
                <th>Created At</th>
                <th>Order Status</th>
                <th>Payment Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var bill in Model)
            {
                <tr>
                    <td>@bill.Bill_Id</td>
                    <td>@bill.Order_Id</td>
                    <td>@bill.Tax_Percentage</td>
                    <td>@bill.Discount_Value</td>
                    <td>@bill.Total</td>
                    <td>@bill.Created_At.ToString("g")</td>
                    <td>@bill.Order_Status</td>
                    <td class="payment-status">@bill.Payment_Status_Name</td>
                    <td>
                        <a asp-controller="Bill" asp-action="Bill" asp-route-orderId="@bill.Order_Id" class="btn btn-sm btn-primary">
                            Details
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- AJAX Filter + Summary Update -->
<script>
    $(document).ready(function () {
        function isMidnight() {
            const now = new Date();
            return now.getHours() === 0;
        }

        function loadData(filterType) {
            if (isMidnight()) {
                $('.card .card-text').text("₹ 0.00");
                $('#billsTable tbody').empty();
                return;
            }

            $.ajax({
                url: '/Bill/GetFilteredData',
                method: 'GET',
                data: { filter: filterType },
                success: function (response) {
                    // Update cards
                    $('.card').each(function () {
                        const title = $(this).find('.card-title').text().trim().toLowerCase();
                        let value = 0;

                        if (title.includes('cash')) value = response.summary.cash || 0;
                        else if (title.includes('upi')) value = response.summary.upi || 0;
                        else if (title.includes('card')) value = response.summary.card || 0;
                        else if (title.includes('total')) value = response.summary.grand || 0;

                        $(this).find('.card-text').text("₹ " + parseFloat(value).toFixed(2));
                    });

                    // Update table
                    let rows = '';
                    response.bills.forEach(bill => {
                        rows += `
                            <tr>
                                <td>${bill.bill_Id}</td>
                                <td>${bill.order_Id}</td>
                                <td>${bill.tax_Percentage}</td>
                                <td>${bill.discount_Value}</td>
                                <td>${bill.total}</td>
                                <td>${bill.created_At}</td>
                                <td>${bill.order_Status}</td>
                                <td class="payment-status">${bill.payment_Status_Name}</td>
                                <td>
                                    <a href="/Bill/Bill?orderId=${bill.order_Id}" class="btn btn-sm btn-primary">Details</a>
                                </td>
                            </tr>`;
                    });
                    $('#billsTable tbody').html(rows);
                },
                error: function () {
                    console.error('Failed to fetch filtered data.');
                }
            });
        }

        // Initial load
        loadData('day');

        // On filter change
        $('#filterType').on('change', function () {
            loadData($(this).val());
        });

        // Optional: refresh every 60 sec
        setInterval(() => loadData($('#filterType').val()), 60000);
    });
</script>
